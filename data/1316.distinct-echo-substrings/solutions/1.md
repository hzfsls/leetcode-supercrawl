## [1316.ä¸åŒçš„å¾ªç¯å­å­—ç¬¦ä¸² ä¸­æ–‡çƒ­é—¨é¢˜è§£1](https://leetcode.cn/problems/distinct-echo-substrings/solutions/100000/by-flix-zsuj)

ä½œè€…ï¼š[flix](https://leetcode.cn/u/flix)
### è§£é¢˜æ€è·¯

é¢˜ç›®æœ¬èº«å³æ˜¯åœ¨ç»™å®šå­—ç¬¦ $s$ ä¸­æ‰¾åˆ°ä¸¤ä¸ªè¿ç»­ä¸”ç›¸ç­‰çš„å­—ç¬¦ç‰‡æ®µ `a`ï¼Œç»Ÿè®¡ä¸åŒçš„ `a` çš„æ•°ç›®ã€‚

æœ¬é¢˜è§£æä¾›ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š

æ–¹æ³•ä¸€ï¼šå­—ç¬¦ä¸²å“ˆå¸Œ
æ–¹æ³•äºŒï¼šKMPç®—æ³•

---
**æ‹“å±•ï¼š**


å­—ç¬¦ä¸²å“ˆå¸Œç¼–ç å’ŒKMPæ˜¯å¤„ç†ä¸€ç³»åˆ—å­—ç¬¦ä¸²åŒ¹é…é—®é¢˜çš„é€šç”¨æ–¹æ³•ï¼Œå¦‚ä»¥ä¸‹é—®é¢˜ï¼š



| é¢˜å· |  é¢˜è§£ | éš¾åº¦ |
| :-----| :---- | :----: |
| [28. å®ç° strStr()](https://leetcode-cn.com/problems/implement-strstr/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œ ã€KMPã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/implement-strstr/solution/zi-fu-chuan-ha-xi-kmp-shuang-jie-by-flix-mlq1/) | ï¼ˆå¹¶ä¸ï¼‰ç®€å• |
| [796. æ—‹è½¬å­—ç¬¦ä¸²](https://leetcode-cn.com/problems/rotate-string/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œ ã€KMPã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/rotate-string/solution/by-flix-eadi/) | ï¼ˆå¹¶ä¸ï¼‰ç®€å• |
| [214. æœ€çŸ­å›æ–‡ä¸²](https://leetcode-cn.com/problems/shortest-palindrome/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œã€KMP ã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/shortest-palindrome/solution/by-flix-be4y/) | å›°éš¾ |
| [1044. æœ€é•¿é‡å¤å­ä¸²](https://leetcode-cn.com/problems/longest-duplicate-substring/) |  [ã€ å­—ç¬¦ä¸²åŒå“ˆå¸Œ + äºŒåˆ† ã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/longest-duplicate-substring/solution/by-flix-fs5k/) | å›°éš¾ |
| ï¼ˆæœ¬é¢˜ï¼‰ [1316. ä¸åŒçš„å¾ªç¯å­å­—ç¬¦ä¸²](https://leetcode-cn.com/problems/distinct-echo-substrings/) |   [ã€ å­—ç¬¦ä¸²å“ˆå¸Œã€KMP ã€æŒæ¡æ¨¡æ¿ï¼Œå›¢ç­ä¸€ä¼—å­—ç¬¦åŒ¹é…é—®é¢˜](https://leetcode-cn.com/problems/distinct-echo-substrings/solution/by-flix-zsuj/) | å›°éš¾ |
| [1392. æœ€é•¿å¿«ä¹å‰ç¼€](https://leetcode-cn.com/problems/longest-happy-prefix/) |  [ã€ å­—ç¬¦ä¸²å“ˆå¸Œã€KMP ã€æŒæ¡æ¨¡æ¿ï¼Œå¿«ä¹å…¶å®å¾ˆç®€å• ğŸ¤£](https://leetcode-cn.com/problems/longest-happy-prefix/solution/by-flix-k4p3/) | å›°éš¾ |
| [2223. æ„é€ å­—ç¬¦ä¸²çš„æ€»å¾—åˆ†å’Œ](https://leetcode-cn.com/problems/sum-of-scores-of-built-strings/) |   [ã€ æš´åŠ›ã€å­—ç¬¦ä¸²ç¼–ç ã€Zå‡½æ•° ã€ä¸‰ç§è§£æ³•è¯¦è§£](https://leetcode-cn.com/problems/sum-of-scores-of-built-strings/solution/by-flix-icgi/) | å›°éš¾ |

---



**æ–¹æ³•ä¸€ï¼šå­—ç¬¦ä¸²ç¼–ç **

**å­—ç¬¦ä¸²ç¼–ç **æ˜¯ä¸€ç§å¸¸ç”¨çš„å­—ç¬¦åŒ¹é…æ–¹æ³•ã€‚ä¸€èˆ¬åœ°ï¼Œä¸€ä¸ªå­—ç¬¦ä¸² $s$ çš„ç¼–ç å€¼è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š

$$encode(s) = \sum_{i=0}^{|s|-1} s[i] * \textit{base}^{|s|-i-1},$$
å…¶ä¸­ $base$ ä¸ºé€‰å®šçš„è¿›åˆ¶å•ä½ã€‚ä¾‹å¦‚ï¼Œæœ¬é¢˜ä¸­ $s$ ä»…åŒ…å« $26$ ä¸ªå°å†™å­—æ¯ï¼Œå› æ­¤ $base$ å¯å–ä¸€ä¸ªå¤§äº $26$ çš„æ•°ï¼ˆå¦‚ $base=31$ï¼‰ã€‚

> ğŸ‘€ ä¸¤ä¸ªå­—ç¬¦ä¸² $s$ å’Œ $t$ ç›¸ç­‰ï¼Œå½“ä¸”ä»…å½“å®ƒä»¬çš„é•¿åº¦ç›¸ç­‰ä¸”ç¼–ç å€¼ç›¸ç­‰ï¼š
    $len(s)=len(t)\ ä¸”\ encode(s) = encode(t)$

&nbsp;
æ¥ä¸‹æ¥é—®é¢˜å°±è½¬åŒ–ä¸ºäº†å¦‚ä½•é¢„å¤„ç†å‡ºä¸åŒé•¿åº¦å­—ç¬¦çš„ç¼–ç è¡¨ç¤ºã€‚

å¯¹äºä»¥ $s[i]$ ç»“å°¾çš„å‰ç¼€å­—ç¬¦ä¸² $s[0,...,i]$ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å¤„ç†å‡ºå…¶ç¼–ç å€¼ï¼Œè®°ä¸º $prefix[i+1]$ã€‚ç‰¹åˆ«åœ°ï¼Œ$prefix[0]=0$ã€‚

å®¹æ˜“å¾—åˆ°ä»¥ä¸‹é€’æ¨å…³ç³»ï¼š
$$prefix[i+1] = prefix[i] * base + encode(s[i])\ .$$

åŸºäºå‰ç¼€ç¼–ç  $prefix$ï¼Œå¯å¿«é€Ÿå¾—åˆ°ä»»ä¸€åŒºé—´å­—ç¬¦çš„ç¼–ç è¡¨ç¤ºï¼š
$$encode(s[left,...,right]) = prefix[right+1]-prefix[left] \times base^{right-left+1}\ .$$
> ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºå­—ç¬¦ä¸² $'b\textcolor{red}{ab}aab'$ å¦‚ä½•å¾—åˆ°ä¸­é—´å­—ç¬¦ $'\textcolor{red}{ab}'$ çš„ç¼–ç è¡¨ç¤ºï¼š
> $$encode('\textcolor{red}{ab}') = encode('b\textcolor{red}{ab}')- encode('b')  \times base^{2}\ .$$

ä¸ºäº†åŠ é€Ÿè¿ç®—ï¼Œä¸Šå¼ä¸­ $base^{right-left+1}$ è¿™ä¸€é¡¹å¯ä»¥é¢„å¤„ç†å‡ºä¸€ä¸ªè¡¨ç¤º $base$ è¿›åˆ¶çš„å¹‚æ¬¡æ•°ç»„ $mul$ï¼Œæ»¡è¶³ï¼š
$$mul[i] = base^{i}$$
&nbsp;

å¯¹äºè¿ç»­çš„ä¸¤ä¸ªé•¿åº¦ä¸º $m$ çš„å­å­—ç¬¦ä¸² $s[i,...,i+m-1]$ å’Œ $s[i+m,...,i+2*m-1]$ï¼Œæˆ‘ä»¬å®¹æ˜“å¾—åˆ°å…¶å„è‡ªçš„å“ˆå¸Œç¼–ç å€¼ã€‚å¦‚æœä¸¤è€…çš„å“ˆå¸Œç¼–ç å€¼ç›¸ç­‰ï¼Œåˆ™å­—ç¬¦ä¸² $s[i,...,i+m-1]$ å°±æ˜¯ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å­ä¸²ã€‚æ­¤å¤–ï¼Œåœ¨éå†å­—ç¬¦è¿‡ç¨‹ä¸­æ³¨æ„å»é‡å³å¯ã€‚
&nbsp;

>  åœ¨å®é™…ç¼–ç ä¸­ï¼Œå½“å­—ç¬¦ä¸²çš„é•¿åº¦å¾ˆé•¿æ—¶ï¼Œå¯¹åº”çš„å“ˆå¸Œç¼–ç å€¼ä¹Ÿä¼šå¾ˆå¤§ï¼Œç”šè‡³ä¼šè¶…å‡ºæ•´æ•°ç±»å‹çš„èŒƒå›´ã€‚å¯¹æ­¤ï¼Œä¸€èˆ¬çš„è§£å†³æ–¹æ³•æ˜¯å¯¹å­—ç¬¦çš„ç¼–ç å€¼è¿›è¡Œå–æ¨¡ï¼ˆ$MOD$ï¼‰ï¼Œä½¿å…¶ä¿æŒåœ¨æ•´æ•°ç±»å‹çš„èŒƒå›´ä¹‹å†…ã€‚

&nbsp;




#### ä»£ç 

```Python3 []
class Solution:
    def distinctEchoSubstrings(self, s: str) -> int:

        MOD = 10**9+7
        base = 31       # sä»…åŒ…å«å°å†™å­—æ¯ï¼Œbaseå¯å–31
        
        '''å­—ç¬¦ç¼–ç å‡½æ•°'''
        def encode(ch):
            return ord(ch) - ord('a') + 1

        n = len(s)
        '''é¢„å¤„ç†å‡ºå‰ç¼€å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼ å’Œ baseè¿›åˆ¶çš„å¹‚'''
        prefix = [0] * (n+1)    # prefix[i]: å­—ç¬¦ä¸²s[0:i]çš„å“ˆå¸Œå€¼
        mul = [1] * (n+1)       # mul[i]: base ** i
        for i in range(1, n+1):
            prefix[i] = ( prefix[i-1] * base + encode(s[i-1]) ) % MOD
            mul[i] = mul[i-1] * base % MOD
        
        ans = 0
        visited = set()
        for i in range(n-1):
            for m in range(1, (n-i)//2+1):      # ç›®æ ‡å­ä¸²çš„é•¿åº¦mï¼š[1, (n-i)//2]
                '''å·¦ä¾§å­—ç¬¦ä¸²: s[i, i+m-1], å³ä¾§å­—ç¬¦ä¸²: s[i+m, i+2m-1]'''
                left = ( prefix[i+m] - prefix[i] * mul[m] % MOD + MOD ) % MOD
                if left in visited:             # å½“å‰å­—ç¬¦å·²è¢«è®°å½•
                    continue
                right = ( prefix[i+2*m] - prefix[i+m] * mul[m] % MOD + MOD ) % MOD
                if left == right:       # å·¦ä¾§å­—ç¬¦ä¸² ä¸ å³ä¾§å­—ç¬¦ä¸² ç›¸åŒ
                    visited.add(left)
                    ans += 1
        
        return ans
```        




&nbsp;

---

**æ–¹æ³•äºŒï¼šKMP**



KMPç®—æ³•æ˜¯ä¸€ç§æ”¹è¿›çš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œç”±D.E.Knuthï¼ŒJ.H.Morriså’ŒV.R.Prattæå‡ºçš„ï¼Œå› æ­¤äººä»¬ç§°å®ƒä¸ºå…‹åŠªç‰¹â€”è«é‡Œæ–¯â€”æ™®æ‹‰ç‰¹æ“ä½œï¼ˆç®€ç§°KMPç®—æ³•ï¼‰ã€‚KMPç®—æ³•çš„æ ¸å¿ƒæ˜¯åˆ©ç”¨åŒ¹é…å¤±è´¥åçš„ä¿¡æ¯ï¼Œå°½é‡å‡å°‘æ¨¡å¼ä¸²ä¸ä¸»ä¸²çš„åŒ¹é…æ¬¡æ•°ä»¥è¾¾åˆ°å¿«é€ŸåŒ¹é…çš„ç›®çš„ã€‚[æºè‡ª [ç™¾åº¦ç™¾ç§‘](https://baike.baidu.com/item/kmp%E7%AE%97%E6%B3%95)]



æœ¬é¢˜æ°æ˜¯ KMP ç®—æ³•çš„ç›´æ¥åº”ç”¨é¢˜ã€‚KMPç›¸å…³åŸç†ä»‹ç»å¯å‚è€ƒï¼š
| è¯¦è§£ |  é“¾æ¥ | æ¥æº |
| :-----| :---- | :----: |
| å¦‚ä½•æ›´å¥½åœ°ç†è§£å’ŒæŒæ¡ KMP ç®—æ³•? | https://www.zhihu.com/question/21923021 | çŸ¥ä¹ |
| å‰ç¼€å‡½æ•°ä¸ KMP ç®—æ³• | https://oi-wiki.org/string/kmp/ | OI Wiki |



[ä»¥ä¸‹æè¿°æ”¹è¿°è‡ª [OI Wiki](https://oi-wiki.org/string/kmp/)]
KMPä¸»è¦é€šè¿‡ä¸€ä¸ª **å‰ç¼€å‡½æ•°**ï¼ˆä¹Ÿå¸¸è¢«ç§°ä¸º$next$æ•°ç»„ï¼‰ æ¥è®°å½•æ¨¡å¼ä¸²çš„å±€éƒ¨åŒ¹é…ä¿¡æ¯ã€‚ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„å­—ç¬¦ä¸² $s$ï¼Œå…¶å‰ç¼€å‡½æ•°è¢«å®šä¹‰ä¸ºä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„æ•°ç»„ $\pi$ã€‚ç®€å•æ¥è¯´ $\pi[i]$ å°±æ˜¯å­ä¸² $s[0,..,i]$ ä¸­ç›¸ç­‰çš„ **çœŸå‰ç¼€** ä¸ **çœŸåç¼€** çš„æœ€é•¿é•¿åº¦ã€‚ç‰¹åˆ«åœ°ï¼Œ$\pi[0] = 0$ã€‚
> * çœŸå‰ç¼€ï¼šæŒ‡é™¤äº† $s$ æœ¬èº«çš„ $s$ çš„å‰ç¼€
> * çœŸåç¼€ï¼šæŒ‡é™¤äº† $s$ æœ¬èº«çš„ $s$ çš„åç¼€

ç”¨æ•°å­¦è¯­è¨€æè¿°å¦‚ä¸‹ï¼š

$$\pi[i]=\max _{k=0 \ldots i}\{\ k: s[0, \ldots, k]=s[i-k, \ldots, i] \ \}$$

> ä¸¾ä¾‹ï¼šå¯ä»¥è®¡ç®—å‡ºå­—ç¬¦ä¸² `aabaaab` çš„å‰ç¼€å‡½æ•°ä¸º $[0,1,0,1,2,2,3]$ã€‚

&nbsp;


**KMP åœ¨æœ¬é¢˜çš„åº”ç”¨ï¼š** 

å¯¹äºæœ¬é¢˜ï¼Œå¦‚ä½•åˆ©ç”¨ KMP æ¥åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦å¯ä»¥å†™ä¸º `a + a` çš„å½¢å¼ï¼Ÿ

ç­”æ¡ˆå¯ä»¥å‚è€ƒé¢˜ç›® [459. é‡å¤çš„å­å­—ç¬¦ä¸²](https://leetcode-cn.com/problems/repeated-substring-pattern/)ï¼š

| é¢˜å· |  é¢˜è§£ | éš¾åº¦ |
| :-----| :---- | :----: |
| 459. é‡å¤çš„å­å­—ç¬¦ä¸² |  [å®˜æ–¹é¢˜è§£](https://leetcode-cn.com/problems/repeated-substring-pattern/solution/zhong-fu-de-zi-zi-fu-chuan-by-leetcode-solution/) | ï¼ˆå¹¶ä¸ï¼‰ç®€å• |

<br>

åœ¨ [459. é‡å¤çš„å­å­—ç¬¦ä¸²](https://leetcode-cn.com/problems/repeated-substring-pattern/) ä¸­ï¼Œå¯¹äºå­—ç¬¦ä¸² $s[0,...,i]$ï¼Œä¸ºåˆ¤æ–­å…¶æ˜¯å¦èƒ½å¤Ÿç”±å…¶ä¸€ä¸ªå­ä¸²é‡å¤å¤šæ¬¡æ„æˆï¼Œæˆ‘ä»¬å…ˆå¤„ç†å‡ºå…¶å‰ç¼€å‡½æ•° $\pi$ï¼Œç„¶åéœ€è¦åˆ¤æ–­ $i+1$ (å­—ç¬¦ä¸²çš„é•¿åº¦) æ˜¯å¦ä¸º $i+1- \pi[i]$ çš„å€æ•°å³å¯ã€‚

å€Ÿé‰´ä»¥ä¸Šæ€æƒ³ï¼Œåœ¨æœ¬é¢˜ä¸­æˆ‘ä»¬åˆ™éœ€è¦åˆ¤æ–­ $i+1$ (å­—ç¬¦ä¸²çš„é•¿åº¦) æ˜¯å¦ä¸º $i+1- \pi[i]$ çš„**å¶æ•°å€**ã€‚è‹¥æ»¡è¶³å¶æ•°å€è¦æ±‚ï¼Œåˆ™å½“å‰å­—ç¬¦ä¸²å¯ç”±å…¶å‰ä¸€åŠå­—ç¬¦å åŠ è€Œæˆã€‚

éå†ä»¥ $s[i]$ èµ·å¤´çš„æ¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶æ³¨æ„å»é‡ï¼Œç´¯åŠ æ‰€æœ‰æ»¡è¶³é¢˜æ„çš„å­—ç¬¦ä¸²å³å¯è§£ç­”æœ¬é¢˜ã€‚




&nbsp;



#### ä»£ç 
```Python3 []
class Solution:
    def distinctEchoSubstrings(self, s: str) -> int:

        def kmp(s):
            ans = 0
            n = len(s)
            pi = [0] * n

            j = 0
            for i in range(1, n):
                while j>0 and s[i] != s[j]:     # å½“å‰ä½ç½®s[i]ä¸s[j]ä¸ç­‰
                    j = pi[j-1]                 # jæŒ‡å‘ä¹‹å‰ä½ç½®ï¼Œs[i]ä¸s[j]ç»§ç»­æ¯”è¾ƒ

                if s[i] == s[j]:                # s[i]ä¸s[j]ç›¸ç­‰ï¼Œj+1ï¼ŒæŒ‡å‘åä¸€ä½
                    j += 1

                pi[i] = j       # pi[i]: s[0,..,i] ä¸­ç›¸ç­‰çš„çœŸå‰ç¼€ä¸çœŸåç¼€çš„æœ€é•¿é•¿åº¦
                # ä»¥ä¸Šä»£ç ä¸º KMP æ¨¡æ¿
                
                # è‡ªæ­¤å¼€å§‹æ»¡è¶³æœ¬é¢˜è¦æ±‚çš„å­—ç¬¦æ•°ç›®ç»Ÿè®¡ï¼š
                m = i+1         # å½“å‰å‰ç¼€å­—ç¬¦ä¸²çš„é•¿åº¦
                if j !=0 and m % (m-j) == 0 and m // (m-j) % 2 == 0:
                    '''ã€m éœ€ä¸º m-j çš„å¶æ•°å€ã€‘'''
                    if s[:m//2] not in visited:     # å½“å‰å‰ç¼€å­—ç¬¦ä¸²çš„ä¸€åŠæ»¡è¶³è¦æ±‚
                        visited.add(s[:m//2])       # è‹¥ä¸é‡å¤ï¼Œåˆ™å¯è®¡å…¥
                        ans += 1
            return ans
        
        '''ä¸»ç¨‹åº'''
        n = len(s)
        visited = set()
        ans  = 0
        for i in range(n-1):
            ans += kmp(s[i:])
        
        return ans
```