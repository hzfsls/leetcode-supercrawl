## [981.åŸºäºæ—¶é—´çš„é”®å€¼å­˜å‚¨ ä¸­æ–‡çƒ­é—¨é¢˜è§£1](https://leetcode.cn/problems/time-based-key-value-store/solutions/100000/gong-shui-san-xie-yi-ti-shuang-jie-ha-xi-h5et)

ä½œè€…ï¼š[AC_OIer](https://leetcode.cn/u/AC_OIer)
## å“ˆå¸Œè¡¨å¥—æ•°ç»„

ç”±äº `timestamp` æ˜¯ä¸¥æ ¼é€’å¢ï¼Œä¸”æ²¡æœ‰åˆ é™¤ KV çš„æ“ä½œã€‚

**æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å“ˆå¸Œè¡¨å¥—æ•°ç»„çš„æ–¹å¼è¿›è¡Œå®ç°ï¼Œä»è€Œè¾¾åˆ°å‡æ‘Š $O(1)$ çš„æ’å…¥æ“ä½œå’Œ $O(\log{n})$ çš„æŸ¥è¯¢æ“ä½œã€‚**

å…·ä½“çš„ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå»ºä¸€ä¸ª `Node` ç±»ï¼Œç±»ä¸­åŒ…å«é”®å€¼å¯¹å’Œæ—¶é—´æˆ³ä¿¡æ¯ã€‚

ç„¶åä½¿ç”¨ä¸€ä¸ªå…¨å±€å“ˆå¸Œè¡¨ `map` è®°å½•æŸä¸ª `key` å¯¹åº”äº†å“ªäº› `Node`ã€‚å…¶ä¸­å¤šä¸ª `Node` æ˜¯ä»¥åŠ¨æ€æ•°ç»„çš„å½¢å¼è¿›è¡Œã€Œä»¥ `timestamp` å‡åºã€å­˜å‚¨ï¼š

* `set` æ“ä½œï¼šä»¥ $O(1)$ çš„å¤æ‚åº¦æ‰¾åˆ°æŸä¸ª `key` å¯¹åº”çš„æ•°ç»„ï¼Œåˆ©ç”¨ `timestamp` ä¸¥æ ¼é€’å¢çš„ç‰¹æ€§ï¼Œä»¥ $O(1)$ å¤æ‚åº¦å°†æ–° `Node` åŠ å…¥å½“å‰æ•°ç»„å°¾éƒ¨ï¼›
* `get` æ“ä½œï¼šä»¥ $O(1)$ çš„å¤æ‚åº¦æ‰¾åˆ°æŸä¸ª `key` å¯¹åº”çš„æ•°ç»„ï¼Œåˆ©ç”¨ `timestamp` ä¸¥æ ¼é€’å¢çš„ç‰¹æ€§ï¼Œé€šè¿‡äºŒåˆ†ä»¥ $O(\log{n})$ å¤æ‚åº¦æ‰¾åˆ°å¯èƒ½ç¬¦åˆæ¡ä»¶çš„ `Node`ã€‚

ä»£ç ï¼š
```Java []
class TimeMap {
    class Node {
        String k, v; 
        int t;
        Node (String _k, String _v, int _t) {
            k = _k; v = _v; t = _t;
        }
    }
    
    Map<String, List<Node>> map = new HashMap<>();
    public void set(String k, String v, int t) {
        List<Node> list = map.getOrDefault(k, new ArrayList<>());
        list.add(new Node(k, v, t));
        map.put(k, list);
    }
    
    public String get(String k, int t) {
        List<Node> list = map.getOrDefault(k, new ArrayList<>());
        if (list.isEmpty()) return "";
        int n = list.size();
        int l = 0, r = n - 1;
        while (l < r) {
            int mid = l + r + 1 >> 1;
            if (list.get(mid).t <= t) {
                l = mid;
            } else {
                r = mid - 1;
            }
        }
        return list.get(r).t <= t ? list.get(r).v : "";
    }
}
```
* æ—¶é—´å¤æ‚åº¦ï¼š`set` æ“ä½œçš„å¤æ‚åº¦ä¸º $O(1)$ï¼›`get` æ“ä½œçš„å¤æ‚åº¦ä¸º $O(\log{n})$
* ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$

---

## å“ˆå¸Œè¡¨å¥—æ ‘

å¦‚æœå¢åŠ  `del` æ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åšå‡ºä½•ç§è°ƒæ•´ï¼Ÿ

è€ƒè™‘åœ¨åŸé¢˜çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ª `String del(String k, int t)` çš„åŠŸèƒ½ï¼šå°†ä¸¥æ ¼ç­‰äºé”®å’Œæ—¶é—´æˆ³çš„ KV å¯¹åˆ æ‰ã€‚

**ç”±äºå­˜åœ¨åˆ é™¤ KV çš„åŠ¨ä½œï¼Œæˆ‘ä»¬éœ€è¦å°†å®ç°ä»ã€Œå“ˆå¸Œè¡¨å¥—æ•°ç»„ã€æ”¹æˆã€Œå“ˆå¸Œè¡¨å¥—æ ‘ã€ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨åŸºäºçº¢é»‘æ ‘å®ç°çš„ `TreeMap` å³å¯ã€‚**

åŒæ—¶ä¸ºäº†éªŒè¯åˆ é™¤é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬åœ¨ `get` åŠ¨ä½œå‘ç”Ÿå‰ï¼Œå…ˆäº§ç”Ÿä¸€æ¬¡éšæœºæ€§çš„åˆ é™¤ï¼Œåˆ é™¤ååˆé‡æ–°æ’å…¥ã€‚


ä»£ç ï¼š
```Java []
class TimeMap {
    class Node {
        String k, v;
        int t;
        Node (String _k, String _v, int _t) {
            k = _k; v = _v; t = _t;
        }
    }

    Map<String, TreeMap<Integer, Node>> map = new HashMap<>();
    public void set(String k, String v, int t) {
        update(k, t);
        TreeMap<Integer, Node> ts = map.getOrDefault(k, new TreeMap<Integer, Node>());
        ts.put(t, new Node(k, v, t));
        map.put(k, ts);
    }

    Node _get(String k, int t) {
        TreeMap<Integer, Node> ts = map.get(k);
        if (ts == null) return null;
        Map.Entry<Integer, Node> entry = ts.floorEntry(t);
        if (entry == null) return null;
        Node node = entry.getValue();
        return node;
    }

    public String get(String k, int t) {
        randomDel();
        Node node = _get(k, t);
        return node != null && node.t <= t ? node.v : "";
    }

    public String del(String k, int t) {
        TreeMap<Integer, Node> ts = map.get(k);
        if (ts == null) return null;
        Map.Entry<Integer, Node> entry = ts.floorEntry(t);
        if (entry == null) return null;
        Node node = entry.getValue();
        if (node != null && node.t == t) {
            ts.remove(t);
            return node.v;
        }
        return "";
    }

    List<String> allInfo = new ArrayList<>(); 
    Random random = new Random();
    // ä¿å­˜æ‰€æœ‰çš„ kt ä¿¡æ¯
    void update(String k, int t) {
        String nk = k + "_" + t;
        allInfo.add(nk);
    } 
    // éšæœºåˆ é™¤ï¼Œå†é‡æ–°æ’å…¥ï¼ŒéªŒè¯ä»£ç æ­£ç¡®æ€§
    void randomDel() {
        int idx = random.nextInt(allInfo.size());
        String[] ss = allInfo.get(idx).split("_");
        String k = ss[0];
        int t = Integer.parseInt(ss[1]);
        Node node = _get(k, t);
        del(node.k, node.t);
        set(node.k, node.v, node.t);
    }
}
```
* æ—¶é—´å¤æ‚åº¦ï¼š`set` æ“ä½œçš„å¤æ‚åº¦ä¸º $O(\log{n})$ï¼›`get` æ“ä½œä¼šå®Œæˆéšæœºåˆ é™¤/é‡æ–°æ’å…¥/æŸ¥è¯¢çš„åŠ¨ä½œï¼Œå¤æ‚åº¦å‡ä¸ºä¸º $O(\log{n})$ï¼Œæ•´ä¸ª `get` çš„å¤æ‚åº¦ä»æ˜¯ $O(\log{n})$ï¼ˆåªæ˜¯å¸¸æ•°å˜å¤§äº†ï¼‰
* ç©ºé—´å¤æ‚åº¦ï¼š$O(n)$

---

## æœ€å

å¦‚æœæŠŠè§£æ³•äºŒä¸­çš„ `randomDel` å»æ‰ï¼Œåœ¨è°ƒç”¨æ¬¡æ•°ä¸º `120000` çš„æ•°é‡çº§ä¸‹ï¼Œä¸¤ç§å®ç°æ•ˆç‡ç›¸å·®ä¸å¤§ï¼Œè€Œè§£æ³•äºŒè¿˜æ”¯æŒäº†åˆ é™¤æ“ä½œã€‚

åƒè¿™æ ·çš„ **æ¶‰åŠæ•°æ®ç»“æ„è¿ç”¨** çš„ **è®¾è®¡ç±»** é¢˜ç›®æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ï¼Ÿ

æ­¤ç±»é¢˜ç›®æœ¬èº«ä¸è€ƒå¯Ÿå®é™…çš„ç®—æ³•ï¼Œæ›´å¤šçš„è€ƒå¯Ÿé€‰æ‰‹çš„ã€Œå¯¹å„ç§æ•°æ®ç»“æ„å¯¹åº”æ“ä½œçš„å¤æ‚åº¦è®¤è¯†ã€ã€ã€Œè®¾è®¡èƒ½åŠ›ã€å’Œã€Œç¼–ç èƒ½åŠ›ã€ã€‚

**æ›´å¤šä¸æ­¤ç±»é¢˜ç›®ç›¸å…³çš„è®²è§£ä¼šåœ¨ LeetBook [ã€Šè®¾è®¡æ•°æ®ç»“æ„ã€‹](https://leetcode-cn.com/leetbook/detail/designing-data-structures/) å‘ˆç°ï¼Œæœ¬ LeetBook å°†ä¼šå’Œå¤§å®¶å°† LC ä¸Šæ‰€æœ‰ä¸ã€Œè®¾è®¡ã€ç›¸å…³çš„é¢˜ç›®éƒ½å®ç°ä¸€éï¼Œç”±æµ…å…¥æ·±ï¼Œä»çƒ­é—¨åˆ°å¸¸è§„ã€‚æ¬¢è¿è·å–å‘€ ~ ğŸ­ğŸ­ğŸ­**